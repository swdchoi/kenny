<div class="container my-5">

  <!-- PAGE HEADER -->
  <div class="mb-4">
    <h2 class="fw-bold mb-1">Financial Insights</h2>
    <p class="text-muted mb-0">
      Last 30 days performance and upcoming 30â€“90 day cash flow outlook
    </p>
  </div>

  <!-- ========================= -->
  <!-- LAST 30 DAYS KPI CARDS -->
  <!-- ========================= -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-primary h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">Issued (Last 30 Days)</h6>
          <h3 class="fw-bold text-primary">
            $<%= number_with_precision(@issued_total, precision: 2) %>
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-success h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">Collected (Last 30 Days)</h6>
          <h3 class="fw-bold text-success">
            $<%= number_with_precision(@collected_total, precision: 2) %>
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-warning h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">Outstanding</h6>
          <h3 class="fw-bold text-warning">
            $<%= number_with_precision(@outstanding_total, precision: 2) %>
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-danger h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1">Overdue</h6>
          <h3 class="fw-bold text-danger">
            $<%= number_with_precision(@overdue_total, precision: 2) %>
          </h3>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- UPCOMING CASH FLOW -->
  <!-- ========================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0">Upcoming Cash Flow Exposure</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card border-info h-100">
            <div class="card-body">
              <h6 class="text-muted mb-1">Due Next 30 Days</h6>
              <h4 class="fw-bold text-info">
                $<%= number_with_precision(@due_next_30, precision: 2) %>
              </h4>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card border-warning h-100">
            <div class="card-body">
              <h6 class="text-muted mb-1">Due Next 60 Days</h6>
              <h4 class="fw-bold text-warning">
                $<%= number_with_precision(@due_next_60, precision: 2) %>
              </h4>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card border-danger h-100">
            <div class="card-body">
              <h6 class="text-muted mb-1">Due Next 90 Days</h6>
              <h4 class="fw-bold text-danger">
                $<%= number_with_precision(@due_next_90, precision: 2) %>
              </h4>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- UPCOMING INVOICES TABLE -->
  <!-- ========================= -->
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0">Upcoming Invoices (Next 90 Days)</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>Contract</th>
            <th>Due Date</th>
            <th class="text-end">Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% @upcoming_invoices.each do |invoice| %>
            <% status = invoice.derived_status %>
            <tr class="<%= 'table-danger' if status == 'overdue' %>">
              <td><%= invoice.payment_term.description %></td>
              <td><%= invoice.due_date.strftime("%d %b %Y") %></td>
              <td class="text-end">
                $<%= number_with_precision(invoice.payment_term.amount, precision: 2) %>
              </td>
              <td>
                <span class="badge bg-<%= {
                  "paid" => "success",
                  "issued" => "warning",
                  "overdue" => "danger"
                }[status] %>">
                  <%= status.capitalize %>
                </span>
              </td>
            </tr>
          <% end %>

          <% if @upcoming_invoices.empty? %>
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                No upcoming invoices in the next 90 days
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

</div>
